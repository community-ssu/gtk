#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# This is the debhelper compatibility version to use.
export DH_COMPAT=4
export DH_OPTIONS
#export DH_VERBOSE=1

pyversions=2.4
defversion=2.4
files=pyrexc

configure: configure-stamp
configure-stamp:
	dh_testdir
	# nothing to do
	touch configure-stamp

build: build-stamp

build-stamp: configure-stamp 
	# remove garbage files
	find . -name .DS_Store -exec rm -rf {} \;
	# make sure most files are not executable
	find [DPTCs]* -type f -exec chmod -x {} \;
	dh_testdir
	# nothing to do
	touch build-stamp

clean:
	dh_testdir
	dh_testroot
	rm -f build-stamp configure-stamp

	-(set -e; for version in $(pyversions); do \
  	python$$version setup.py clean --all ;\
	done)
	# delete *.pyc generated by setup.py
	find . -name '*.pyc' -exec rm -rf {} \;
	
	dh_clean

install: build
	dh_testdir
	dh_testroot
	dh_clean -k 
	dh_installdirs

	# fix executable file : headers, names 
	# $$file -> python$$version-$$file
	curdir=$(CURDIR); \
	set -e; for version in $(pyversions); do \
		for file in $(files); do \
			python$$version setup.py install --root=$$curdir/debian/python$$version-pyrex --no-compile ;\
			sed -i "s|#!/usr/bin/python.*|#!/usr/bin/python$$version|" \
				 $$curdir/debian/python$$version-pyrex/usr/bin/$$file ;\
			mv $$curdir/debian/python$$version-pyrex/usr/bin/$$file \
				 $$curdir/debian/python$$version-pyrex/usr/bin/python$$version-$$file ;\
			install -d $$curdir/debian/python$$version-pyrex/usr/share/man/man1/ ;\
			install -p -m644 $$curdir/debian/python$$version-$$file.1 \
				 $$curdir/debian/python$$version-pyrex/usr/share/man/man1/python$$version-$$file.1 ;\
		done \
	done
	dh_install -p pyrex-mode
	

binary-common: 

	dh_testdir
	dh_testroot
	dh_installdebconf	
	dh_installchangelogs CHANGES.txt
	dh_installdocs
	dh_installexamples

	# default version link for binary and manpage
	unset DH_OPTIONS; \
	for file in $(files); do \
		dh_link -ppython-pyrex \
			usr/bin/python$(defversion)-$$file \
			usr/bin/$$file \
			usr/share/man/man1/python$(defversion)-$$file.1.gz \
			usr/share/man/man1/$$file.1.gz ;\
	done
	
	dh_strip
	dh_compress
	dh_fixperms
	dh_python
	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

# Build architecture-independent files here.
binary-indep: build install
# We have nothing to do by default.
	$(MAKE) -k -f debian/rules DH_OPTIONS=-i binary-common

# Build architecture-dependent files here.
binary-arch: build install
	#$(MAKE) -f debian/rules DH_OPTIONS=-a binary-common
	
binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install configure
