2005-09-06  Marius Vollmer  <marius.vollmer@nokia.com>

	* src/core.c (package_file_info): Do not insist that the "maemo"
	package itself depends on "maemo".
	(install_package): Allow upgrades of the "maemo" package.

2005-09-05  Marius Vollmer  <marius.vollmer@nokia.com>

	* src/core.h (PackageInfo): Added field rejection_reason.
	* src/core.c (package_file_info): Set it for incompatible
	packages.  Check for builtin packages before this.	
	* src/ui/represent.c (show_info_banner): New.
	(confirm_install): Make yes button insensitive when there is a
	rejection_reason and show it with show_info_banner when the button
	is pressed nevertheless.

2005-09-02  Marius Vollmer  <marius.vollmer@nokia.com>

	* src/core.c (do_copy): Call gnome_vfs_async_cancel after the main
	loop has returned.  Use copy_progress as the 'sync' callback for
	no particular reason.
	(copy_progress): Do not handle spurious invocations since
	copy_data is static.  Also quit the main loop on errors.
	(install_package_from_uri): Put temporary copy into /var/tmp.
	
	* src/appdata.h (AppData): New fields delay_mime_open and
	mime_open_param.

	* src/dbus.h, src/dbus.c (register_mime_open_handler): Removed.
	(init_osso): Do it here.
	(mime_open_handler): Only store away URI when opening is being
	delayed.

	* src/main.c (main): Use delay_mime_open to get the sequence of
	initializations right.  Do not call register_mime_open_handler.

2005-09-01  Marius Vollmer  <marius.vollmer@nokia.com>

	* src/appdata.h (AppUIData): New fields main_vbox,
	full_focus_chain, and install_close_focus_chain.
	* src/ui/interface.c (ui_create_main_dialog): Initialize them.  Do
	not set focus chain here.
	* src/ui/represent.c (update_package_list): Set one of the focus
	chains here.  Do not ever disable the "Install new" button.

	* src/core.c (run_app_installer_tool): Correctly initialize
	'data.loop'.

2005-08-31  Marius Vollmer  <marius.vollmer@nokia.com>

	Released 2.9.
	
	* configure.ac: Bumped version to 2.9-0.

	* src/core.c (package_file_info): Use report_installation_failure
	instead of present_report_with_details to present
	"ai_error_builtin" and "ai_error_corrupted".

	* src/ui/interface.c (ui_create_textbox): Set the vadjustment of
	the scrolled window instead of scrolling the text view.  The
	latter doesn't really seem to work before the widget is realized
	or something.
	(keypress_event): New.
	(ui_create_main_dialog): Make description text view sensitive,
	non-editable and hide the cursor.  Use keypress_event to get focus
	behavior right.  Also set up an explicit focus chain for this.

	* src/core.c (cancel_app_installer_tool): Commented out since it
	is not used right now.
	(installer_cancel): Removed, doesn't work.
	(installer_progress): Don't use it.
	(copy_data, copy_progress, do_copy): Rewritten logic, especially
	to do cancelling the 'right' way.
	
2005-08-30  Marius Vollmer  <marius.vollmer@nokia.com>

	* src/core.c (do_copy, copy_progress, copy_cancel): New, for doing
	the copy ourselves with ovu_async_xfer and a cancellable progress
	dialog.
	(report_installation_failure): New.
	(install_package_from_uri): Use it to clean up control flow.
	Also, use do_copy to do the copy.
	
	* configure.ac (AITOOLS_CFLAGS, AITOOLS_LIBS): Removed gnome-vfs
	(DEPS): Do not put comman in front of glib-2.0 dependency.  Added
	obex-vfs-utils.

	* app-installer-tool/app-installer-tool.c (do_copy, copy_progress,
	copy_data): Removed.
	(main): Do not handle "copy" command.

	* src/ui/interface.c (ui_create_progress_dialog): Do not force
	cancel_callback to zero, it is used now during copying.
	(ui_create_textbox): Allocate a complete GtktextIter struct and
	not a pointer to it.

	* src/ui/represent.h, src/ui/represent.c
	(present_error_details_fmt): New.

	* po/en_GB.po: Make it conform better to the UI spec version 4.0.
	In particular:
	(ai_ti_broken_description): Changed text according to UI spec.
	(ai_ti_copying_failed, ai_ti_copying): Removed.
	(ai_bd__install_application_cancel, ai_bd_ confirm_uninstall_ok,
	ai_bd_ confirm_uninstall_cancel, ai_ap_application_title,
	ai_ti_uninstallation_failed_ok): Added.
	(Ai_ti_application_uninstalled_ok): Renamed to
	ai_bd_application_uninstalled_ok.
	(ai_bd_application_installed__ok): Renamed to
	ai_bd__application_installed__ok.
	
2005-08-29  Marius Vollmer  <marius.vollmer@nokia.com>

	* src/dbus.h, src/dbus.c (register_mime_open_handler): New.
	(init_osso): Do not register mime callback here.
	* src/main.c (main): Initialize osso before creating the main
	dialog, but register mime-open handler afterwards.

	* src/ui/interface.c (ui_create_main_dialog): Log error when help
	could not be activated.
	(ui_create_textbox): Scroll to beginning of text.
	
2005-08-25  Marius Vollmer  <marius.vollmer@nokia.com>

        * po/en_GB.po (ai_ti_copying, ai_ti_copying_failed): New.
	
	* app-installer-tool/app-installer-tool.c (copy_progress,
	do_copy): Round progress fraction to to multiples of 1/40.  Only
	output them when they are different from the previous one.

	* src/core.c (package_already_installed): If model is NULL, treat
	it as empty.
	(copy_data, copy_callback, copy_stdout_callback,
	install_package_from_uri): Use ui_create_progress_dialog etc for
	showing the progress of the copying.  Use ai_ti_copying_failed in
	preference to ai_ti_installation_failed_text, and ai_ti_copying in
	preference to ai_ti_installing_installing.  Set mode of temporary
	directory to rwxr-xr-x so that app-installer-tool can read from it
	when run as "install".

2005-08-24  Marius Vollmer  <marius.vollmer@nokia.com>

	Released 2.8
	
	* src/ui/callbacks.c (on_treeview_selection_changed): Use
	ai_ti_broken_description or fallback to English text for
	description of broken packages.

	* src/core.c (list_packages): Allow version and size column text
	to be translated with ai_ti_version_column and ai_ti_size_column,
	respectively.  Fallback when no translation is available.
	(install_package): Use either ai_error_alreadyinstalled or
	ai_ti_alreadyinstalled, whichever provides a translation.

	* app-installer-tool/app-installer-tool.c (do_remove): Call
	run_cmd correctly.  Removed unused local variables.

	* src/applicationinstaller-i18n.h, src/main.c (gettext_try_many):
	New.

	* po/en_GB.po (ai_ti_version_column, ai_ti_size_column,
	ai_ti_broken_description): New.
	(ai_info_notenoughmemory): Resurrected.
	
2005-08-22  Marius Vollmer  <marius.vollmer@nokia.com>

	* src/core.c (format_relationship_failures): Don't output ':'
	after ai_ti_dependency_conflict_text.

	* app-installer-tool/app-installer-tool.c (setup_environment): Do
	not set LC_ALL.
	(do_install): When installation fails, rerun the command in the
	"C" locale to be able to parse the output.
	(do_remove): Do not output relationship information.
	(do_get_dependencies): Run command in "C" locale.
	
	* src/core.c (list_packages): Try to load specially named icons
	for each package.

	* osso-application-installer.defs: New.
	* Makefile.am: Install it.
	(EXTRA_DIST): Distribute it.

2005-08-19  Marius Vollmer  <marius.vollmer@nokia.com>

	* src/core.c (format_relationship_failures): Do not look for
	"exists" in output of app-installer-tool.  Look for "full" and
	report it with ai_info_notenoughmemory.

	* app-installer-tool/app-installer-tool.c (do_install): If the
	string corresponding to ENOSPC can be found in the output of dpkg,
	return a "full" indication.

	* src/core.c (package_already_installed): New.
	(install_package): Use it to refuse to install packages that are
	already there.
	(package_file_info): Reject packages for the wrong architectures.
	Say "ai_error_builtin" for packages that do not depend on maemo,
	not "ai_error_incompatible".
	(format_relationship_failures): Use "ai_error_componentmissing"
	instead of untranslated text.

	* po/en_GB.po (ai_error_builtin, ai_error_componentmissing):
	Resurrected.
	
	* configure.ac (DEB_HOST_ARCH): Check for it and subst it.

	* app-installer-tool/app-installer-tool.c
	(package_already_installed): Removed.
	(do_install): Do not refuse to install packages that are present.
	(describe_package): Also emit architecture.

2005-08-18  Marius Vollmer  <marius.vollmer@nokia.com>

	Released 2.7.

	* src/core.c (format_relationship_failures): Changed
	"ai_ti_alreadyinstalled" to "ai_error_alreadyinstalled" since that
	is the string used in the old PO files.  Updated POs.  (Second try
	to get this right...)

	* src/dbus.c (mime_open_handler): Ignore all requests except the
	first.

	* configure.ac (DEPS): Added gconf-2.0.

	* src/core.c (installer_data): New field check_mmc_cover.
	(install_package, uninstall_package): Set it.
	(installer_callback): Check for open MMC cover when requested.

2005-08-16  Marius Vollmer  <marius.vollmer@nokia.com>

	* control-panel/ai-cp-applet.c (show_message): New.
	(ai_exited): Use it to show message in case of non-clean exits.
	(execute): Use show_message instead of explicit code.
	
	* app-installer-tool/app-installer-tool.c: Start error messages
	with a capital letter.
	(package_already_installed, do_list, do_describe_file,
	do_describe_package, dump_failed_relations, do_install, do_remove,
	do_get_dependencies): Deal with output strings that are NULL by
	treating them as empty.  Use g_free instead of free when NULL
	might be passed.
	
2005-08-15  Marius Vollmer  <marius.vollmer@nokia.com>

	* src/appdata.h (AppUIData): Removed ui_manager.
	* src/ui/ui.h (action_entries, n_action_entries, popup_info,
	localize_strings): Removed.
	* src/ui/interface.c (ui_create_main_dialog): Do not create the UI
	manager and the action group for the menu.
	(ui_create_textbox): Create menu with explicit code here.  The
	reason for this change is mostly that I find the UI manager
	confusing and overkill for a single menu.
		
	Made it compile cleanly with "-Wall -Werror".  We should strive to
	keep it this way.
	
	* src/Makefile.am (CFLAGS): Added -Wall -Werror.

	* src/applicationinstaller-i18n.h (SUPPRESS_FORMAT_WARNING): New.

	* src/core.c: (format_relationship_failures): Only output a
	newline between the report and the footer when the report is
	non-empty.

	* src/core.c, src/ui/represent.c, src/ui/interface.c: Made -Wall
	clean.

	* src/ui/interface.c, src/ui/interface.h (main_dialog, hints):
	Removed.
	(ui_create_main_dialog): Set app_ui_data->main_dialog as early as
	possible.  Connect on_button_close to close button, not
	ui_destroy.  Do not connect to key_release_event.
	(ui_destroy): Added AppUIData parameter.
	(ui_create_text_box): Use gtk_widget_tap_and_hold_setup instead of
	doing the timeout stuff ourself.
	
	* src/ui/callbacks.h, src/ui/callbacks.c
	(on_button_close_clicked): New.
	(on_button_cancel_operation, key_release, on_error_press,
	on_error_release, on_popup): Removed.
	(key_press): Only handle GDK_Escape.
	
2005-08-11  Marius Vollmer  <marius.vollmer@nokia.com>

	Released 2.6.
	
	* configure.ac: Bumped version.

	* app-installer-tool/app-installer-tool.c (parse_field): Only skip
	over field if it is indeed the one we are looking for, stupid.
	(do_describe_file): Also output Depends field as fourth line.

	* src/core.c (package_file_info): Expect Depends information from
	app-installer-tool and parse it.  Refuse packages that do not
	depend on the META_PACKAGE.

	* src/core.h, src/core.c (COLUMN_BROKEN): New.
	(list_packages): Set it.
	(text_cell_data_func): New, use the COLUMN_BROKEN field to render
	broken packages struck out.
	(add_columns): Set text_cell_data_func for all text columns.  Set
	"xalign" of text renderer, not column alignment, for right
	adjusted columns.
	
	* src/ui/callbacks.c (on_treeview_selection_changed): Show short
	explanation instead of the description for broken packages.

	* src/ui/interface.c (ui_create_main_dialog): Gove the dialog a
	fixed size by using gtk_widget_size_request

	* src/core.c: Added g_main_loop_unref in all the right places.

	* po/en_GB.po (ai_bd__application_installer_cancel): Translate as
	"Close" to conform to UI spec 3.2.

	* src/core.c (format_relationship_failures): Changed
	"ai_ti_already_installed" to "ai_ti_alreadyinstalled" since that
	is the string used in the old PO files.  Updated POs.

2005-08-10  Marius Vollmer  <marius.vollmer@nokia.com>

	* src/dbus.c, src/dbus.h: Rewritten to just use osso_mime_set_cb
	and no other callbacks.
	(init_osso, deinit_osso): Return void, changed callers.

	* src/main.c (main): Moved osso initialization after dialog
	creation.  Removed some logging fluff.

	* src/osso_application_installer.desktop.in (X-Osso-Service):
	Prepend com.nokia.

	* src/ui/callbacks.c, src/ui/callbacks.h (on_copy_activate): Data
	argument is now the GtkTextBuffer to copy from, not AppData.

	* src/appdata.h (AppUIData): Removed error_buffer, progressbar,
	progressbar_dialog, param, current_progress, max_name, max_size,
	max_version.

	* src/ui/interface.c (ui_create_main_dialog): Hide the alternative
	labels after creating them to avoid UI flicker.
	(ui_create_textbox): Do not set error_buffer of app_ui_data.
	
	* src/ui/represent.c, src/ui/represent.h
	(present_report_with_details): Removed title argument.  Changed
	all callers.
	(update_package_list): Get list of packages before changing any of
	the widget states to avoid UI flicker.

2005-08-09  Marius Vollmer  <marius.vollmer@nokia.com>

	* control-panel/ai-cp-applet.c (execute): Rewritten.  Use
	g_spawn_async, a nested main loop and an invisible event grabber
	widget to run the Application installer process.

	Released 2.5.

	* configure.ac: Bump version number.
	
	* src/ui/represent.c, src/ui/represent.h (all_white_space):
	Advance pointer in loop, stupid.
	(present_error_details): New.
	(present_report_with_details): Redone as a two stage process:
	first show the report as a information or confirmation note, and
	then the details in a second dialog (XXX-UI32).
	
	* src/core.h, src/core.c: Do not use gettext for strings not in
	the UI spec (XXX-UI32).
	(package_file_info): Made static.  Do not present any details when
	failing (XXX-UI32).
	(run_app_installer_tool): Append a hardcoded "See the details?"
	to error description (XXX-UI32).
	(list_packages): Ignore broken packages (XXX-UI32).
	(format_relationship_failures): Return a gchar* instead of a
	GString.  The extra text is now the footer, not the header.
	Changed all callers.
	(installer_data): Added dont_show_details field.
	(installer_callback): Suppress details in case of success and when
	explicitely requested.  Relationship failures are now part of the
	error details, not of the report (XXX-UI32).
	(check_dependencies): New.
	(uninstall_package): Use it to catch dependency errors early.  Use
	the dont_show_details field to suppress any error details
	(XXX-UI32).

	* src/ui/interface.c: Do not use gettext for strings not in the UI
	spec (XXX-UI32).
	(ui_create_progress_dialog): Ignore the cancel_callback
	(XXX-UI32).  Remove Cancel button from progress bar dialog when it
	is not needed.
	
	* app-installer-tool/app-installer-tool.c (do_get_dependencies):
	New.

2005-08-03  Marius Vollmer  <marius.vollmer@nokia.com>

	Released version 2.4-0.

	* configure.ac: Changed version for release.
	
	* src/core.c (install_package_from_uri): use
	gnome_vfs_unescape_string to decode stuff like '%20'.

2005-08-02  Marius Vollmer  <marius.vollmer@nokia.com>

	Throughout: changed logical l10n strings that are not in version
	3.1 of the UI spec to their English translations.
	
	* src/core.c, src/core.h (spawn_app_installer_tool): Return a
	handle.  Changed all callers to free it.
	(free_app_installer_tool): New, for freeing it.
	(cancel_app_installer_tool): New.
	(installer_cancel): New.
	(installer_progress): Use it with the progress dialog.

	* src/ui/interface.h, src/ui/interface.c (progress_dialog,
	ui_create_progress_dialog): Added cancel_callback.

	* src/appdata.h (AppUIData): Renamed database_corrupted_label to
	database_unavailable_label.  Changed all uses.

2005-07-28  Marius Vollmer  <marius.vollmer@nokia.com>

        Released 2.2-0.
	
	* src/core.c (read_into_string): Use read syscall instead of
	g_io_channel_read_chars since the latter blocks sometimes.  Needs
	more investigation.
	(kb_used_in_var_lib_install): Use statvfs instead of spawning
	"du".  The latter fails surprisingly often.

	* src/ui/interface.h (progress_dialog,
	ui_create_progressbar_dialog, ui_close_progress_dialog,
	ui_set_progress_dialog): New.
	* core.c (installer_callback, installer_progress): Use it, but
	only in the pulsing mode.

	* src/ui/callbacks.h, src/ui/callbacks.c (do_install): New.
	(on_button_install_clicked): Use it.
	* src/dbus.c (dbus_message_handler): Likewise.
	* src/main.c (main): Likewise.
	
2005-07-27  Marius Vollmer  <marius.vollmer@nokia.com>

	* configure.ac: Bumped version to 2.1.
	(AITOOLS_CFLAGS, AITOOLS_LIBS): Added gnome-vfs-2.0.
	
	* app-installer-tool/app-installer-tool.c (do_copy): New.

	* src/core.c (run_app_installer_tool): Reimplemented by using
	spawn_app_installer_tool.
	(spawn_app_installer_tool): Take three args for
	app-installer-tool.  Make using sudo optional.  Accept 'line'
	callbacks.  Changed all callers.
	(read_into_string): Call 'line' callbacks as appropriate.
	(kb_used_in_var_lib_install): Log error message in case of
	failure.
	(installer_progress): Deal with errors from
	kb_used_in_var_lib_install.
	(install_package_from_uri): New.

	* src/dbus.c (dbus_message_handler): Use install_package_from_uri
	instead of on_button_install_clicked.
	
	* src/main.c (main): Call install_package_from_uri instead of
	passing it inside app_ui_data.

	* src/ui/callbacks.c (on_button_install_clicked): Use
	install_package_from_uri instead of doing the copying here.  Do
	not look at 'param' from app_ui_data.
	
2005-07-22  Marius Vollmer  <marius.vollmer@nokia.com>

	* Makefile.am (SUBDIRS): Removed wrapper.
	* configure.ac: Do not create wrapper/Makefile.

	* src/ui/interface.c (ui_create_main_dialog): Do not use
	"row-activated" signal of treeview, use "changed" signal of its
	selection.

	* src/ui/callbacks.h, src/ui/callbacks.c (on_treeview_activated):
	Renamed to on_treeview_selection_changed and adapted to be useable
	as a "changed" signal handler for the tree selection.

	
	First round of the big rewrite.  Main things missing: context
	sensitive menu and direct installation from command line argument.
	
	* configure.ac: Changed version to 2.0-0.  Handle
	"--disable-sudo".  Check for the depencies of app-installer-tool.

	* src/core.c, src/core.h: Rewritten, changed everything.

	* src/ui/represent.h, src/ui/represent.c: Removed unused defines.
	(represent_packages): Renamed to update_package_list.  Take
	AppData instead of AppUIData.  Changed all callers.  Deal with
	errors from list_packages.
	(represent_confirmation, represent_dependencies, represent_error,
	represent_notification, show_dialog): Removed.
	(present_report_with_details, confirm_install, confirm_uninstall):
	New.
	
	* src/ui/interface.h, src/ui/interface.c: Removed unused defines.
	(ui_freeze_column_sizes, ui_show_notification, ui_set_progressbar,
	ui_pulse_progressbar, ui_create_progressbar_dialog,
	ui_cleanup_progressbar_dialog): Removed.
	(ui_read_selected_package): Also return size.  Do not test for
	special entries to ignore, they are not used anymore.
	(ui_create_main_dialog): Create database_corrupted_label.  Only
	update list of apckages after everything has been created.  This
	allows the list updating to display errors.  Do not set textbuffer
	to MESSAGE_DOUBLECLICK, whatever that was meant to be.  Removed
	code for doing direct install.
	
	* src/ui/callbacks.c, src/ui/callbacks.h (on_treeview_activated):
	Use AppData instead of AppUIData.  Changed all callers.
	(on_button_install_clicked): Only test for "file://" method whend
	deciding whether to copy the file or not.  See the source for a
	rationale.

	* src/main.c (main): Temporarily disabled direct installation.

	* src/definitions.h: Removed unused defines.

	* src/appdata.h (AppUIData): Removed builtin_packages, added
	database_corrupted_label.

	* Makefile.am (SUBDIRS): Added app-installer-tool.

	* app-installer-tool/app-installer-tool.c: Added prototypes.
	Expanded usage message.
	(setup_environment): Set "LC_ALL" instead of "LANG".
	(do_list): Use "--showformat" instaed of "-f" since the latter is
	not supported by the dpkg-query on the target.
	(do_describe_package): Likewise.
	(parse_field): New.
	(do_describe_file): Use it to provide package name, version and
	size in addition to description.
	(do_install): Run dpkg with fakeroot.  Removed "--log",
	"--force-not-root" and "--force-bad-path" options accordingly.
	(do_uninstall): Likewise.
	(do_install): Return 1, not -1, when the package exists.
	(do_env): Removed.

	* maemo.control: Changed version to 1.0.

2005-07-21  Marius Vollmer  <marius.vollmer@nokia.com>

	* autogen.sh: Use "--copy --force" also with libtoolize and
	"--copy" with autoconf to avoid symlinks in the source tree.

2005-07-19  Marius Vollmer  <marius.vollmer@nokia.com>

	* app-installer-tool/Makefile.am,
	app-installer-tool/app-installer-tool.c: New.

2005-07-19  Marius Vollmer  <marius.vollmer@nokia.com>

	Released version 1.0.29-0.

	* configure.ac: Increased version number.
	* make-package: Use "-uc -us -sa -D" options for
	dpkg-buildpackage.

2005-07-18  Marius Vollmer  <marius.vollmer@nokia.com>

	* maemo.control, maemo.dirs: New files, for building the maemo.deb
	package.
	
	* Makefile.am: Build and install the maemo.deb package.
	(install-data-local, dist-hook): Removed since /var/lib/install is
	now created by postinst.
	(EXTRA_DIST): Added maemo.control and maemo.dirs.
	
	* make-package: Expect location of debian/ directory as argument.
	* Makefile.am (DEBIAN, deb): Provide it, in an overridable way.

	* src/Makefile.am (script_DATA): Do not use $(srcdir) here.
	(EXTRA_DIST): New, since script_DATA is not distributed
	automatically.

2005-07-14  Marius Vollmer  <marius.vollmer@nokia.com>

	* make-package: New.
	
	* Makefile.am (deb): Replaced with call to make-package.
	(dist-hook): New, to include data/ in distribution.
	(install-data-local): New, to create /var/lib/install
	
2005-07-13  Marius Vollmer  <marius.vollmer@nokia.com>

	* Makefile.am, src/Makefile.am (DISTCLEANFILES): Added so that
	files created by configure get deleted by "make distclean".

	* src/Makefile.am (script_DATA): Get the files from $(srcdir) to
	enable a VPATH build.

	* control-panel/Makefile.am (CLEANFILES, DISTCLEANFILES): Moved
	.desktop files to DISTCLEANFILES since they are created by
	configure.

	* Imported version 1.0.28 into public repository.
