#!/usr/bin/make -f

PYVER=2.4
PYTHON=python$(PYVER)

p_base=$(PYTHON)-gtk2
p_dev=$(PYTHON)-gtk2-dev

d=$(CURDIR)/debian/tmp
d_base=debian/$(p_base)
d_dev=debian/$(p_dev)

ifeq ($(DEB_BUILD_ARCH),armel)
    CFLAGS=-Os -mthumb -mfloat-abi=softfp -Wall -Wstrict-prototypes
else
    CFLAGS=-Os -Wall -Wstrict-prototypes
endif


build/config.status: configure
	dh_testdir
	mkdir -p build
	autoconf
	cd build && \
	  CFLAGS="$(CFLAGS)" \
	  PYTHON=`which $(PYTHON)` \
		../configure \
			--prefix=/usr \
			--enable-thread \
			--disable-numpy

build:  build/config.status build-stamp
build-stamp: 
	dh_testdir
	$(MAKE) -C build
	touch build-stamp

clean:
	dh_testdir
	dh_testroot
	rm -f *-stamp
	rm -Rf debian/tmp-*
	-rm -rf $(d_base) $(d_dev)
	-rm -rf debian/$(PYTHON)-gtk2-dev
	-rm -rf build
	find -name "*.pyc" -exec rm -f {} \;
	find -name "*.pyo" -exec rm -f {} \;
	dh_clean codegen/*.pyc

install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs
	$(MAKE) -C build install DESTDIR=$(d)

	rm -rf $(d_base) && mkdir -p $(d_base)
	rm -rf $(d_dev) && mkdir -p $(d_dev)

	# Base
	mkdir -p $(d_base)/usr/lib
	cp -a $(d)/usr/lib/$(PYTHON)		$(d_base)/usr/lib
	find $(d_base) -name "*.py" -exec rm -f {} \;
	find $(d_base) -name "*.pyc" -exec rm -f {} \;
	find $(d_base) -name "*.la" -exec rm -f {} \;

	# Dev
	mkdir -p $(d_dev)/usr/bin
	mkdir -p $(d_dev)/usr/lib/pygtk/2.0
	mkdir -p $(d_dev)/usr/share/pygtk/2.0
	mkdir -p $(d_dev)/usr/include
	mv $(d)/usr/bin/pygtk-demo 		$(d_dev)/usr/bin
	mv $(d)/usr/lib/pkgconfig		$(d_dev)/usr/lib
	mv $(d)/usr/lib/$(PYTHON)		$(d_dev)/usr/lib
	mv $(d)/usr/lib/pygtk/2.0/pygtk-demo.py	$(d_dev)/usr/lib/pygtk/2.0
	mv $(d)/usr/lib/pygtk/2.0/demos		$(d_dev)/usr/lib/pygtk/2.0
	mv $(d)/usr/bin/pygtk-codegen-2.0	$(d_dev)/usr/bin
	mv $(d)/usr/share/pygtk/2.0/codegen	$(d_dev)/usr/share/pygtk/2.0
	mv $(d)/usr/share/pygtk/2.0/defs	$(d_dev)/usr/share/pygtk/2.0
	mv $(d)/usr/include/pygtk-2.0		$(d_dev)/usr/include
	find $(d_dev) -name "*.pyc" -exec rm -f {} \;
	find $(d_dev)/usr/lib -name "*.pyo" -exec rm -f {} \;
	find $(d_dev) -name "*.so" -exec rm -f {} \;
	find $(d_dev) -name "*.pth" -exec rm -f {} \;

binary: build install
binary-indep: build install
binary-arch: build install
	dh_testdir
	dh_testroot
	dh_installexamples

	# Replace all '#!' calls to python with $(PYTHON)
	for i in `find debian/python2.4* -type f`; do \
	  sed "1s,#!.*python[^ ]*\(.*\),#!/usr/bin/$(PYTHON)," \
		$$i > $$i.temp; \
	  if cmp --quiet $$i $$i.temp; then \
	    rm -f $$i.temp; \
	  else \
	    mv -f $$i.temp $$i; \
	    chmod 755 $$i; \
	    echo "fixed interpreter: $$i"; \
	  fi; \
	done

	dh_strip
	dh_link
	dh_compress
	dh_fixperms
	dh_makeshlibs
	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

.PHONY: build clean binary install 
