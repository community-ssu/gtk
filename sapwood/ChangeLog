2007-01-27  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/sapwood-draw.c (get_window_for_shape): Consider setting the
	window shape mask only when painting to widget->window, otherwise it
	can cause an infinite expose loop.

2007-01-25  Tommi Komulainen  <tommi.komulainen@nokia.com>
	
	* === Release 2.91.0 ===

2007-01-25  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* Makefile.am (SUBDIRS)
	* configure.in (AC_OUTPUT): add demos directory

	* demos/run-demo: add wrapper script for running demos without
	installing libsapwood.so
	* demos/buttonbox.c
	* demos/buttonbox.gtkrc
	* demos/images/hbbox*.png: Example for dialog button theming

2007-01-24  Tommi Komulainen  <tommi.komulainen@nokia.com>

	Implement dialog buttons using explicit "position" keyword. The
	position is calculated only for buttons in button boxes for now.
	Specific graphics can be applied with something like:
	  position = LEFT,TOP,RIGHT,BOTTOM	(solitary)
	  position = TOP,LEFT,BOTTOM		(leftmost)
	  position = TOP,BOTTOM			(middle)
	  position = TOP,RIGHT,BOTTOM		(rightmost)

	* src/sapwood-draw.c (match_theme_image): check position flags
	(maybe_set_dialog_button_details, draw_simple_image): rename
	maybe_set_dialog_button_details to maybe_check_button_position
	(maybe_check_button_position): don't check or modify the detail,
	instead use the position match flags
	* src/sapwood-rc-style.c (theme_symbols): add "position"
	(theme_parse_position): parse "position = LEFT,RIGHT,TOP,BOTTOM"
	(theme_parse_image): parse "position"
	* src/theme-pixbuf.h: add TOKEN_POSITION and ThemePositionfFlags
	(ThemeMatchFlags): add THEME_MATCH_POSITION
	(ThemeMatchData): increase the flags size to hold
	'THEME_MATCH_POSITION' and add ThemePositionfFlags

2007-01-24  Tommi Komulainen  <tommi.komulainen@nokia.com>

	Adjust the detail for buttons in button boxes depending on the button
	position inside the button box for enhanced theming (special rounding
	for outmost button edges.) For horizontal button box we use the
	following details to work with existing themes:
	- osso_button_nesw
	- osso_button_nsw
	- osso_button_nes
	- osso_button_ns

	vertical:
	- osso_button_nesw
	- osso_button_new
	- osso_button_esw
	- osso_button_ew

	NOTE: this loses the ability to theme the 'default' response button
	differently from the others. We could use 'osso_buttondefault_nesw' or
	similar but that would then require duplicate theme declarations or
	risk really bad looking theming when the 'default' style is used
	without matching graphics. Some way to handle fallbacks
	(buttondefault-shaped - button-shaped - buttondefault - button) could
	be useful.

	* src/sapwood-draw.c (maybe_set_dialog_button_details,
	draw_simple_image): When painting GtkButtons check if it's contained
	in a button box, and if so figure out the position
	(solitary,left,right,middle - similarly for vertical) and replace the
	detail with specific ones matching the position.

2007-01-24  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/sapwood-pixmap.c (sapwood_pixmap_get_pixmap): Switch x/y indices
	the right way around.

2007-01-24  Tommi Komulainen  <tommi.komulainen@nokia.com>
	
	* src/sapwood-rc-style.c (theme_symbols): Remove unused tokens
	TOKEN_D_POLYGON, TOKEN_D_OVAL, TOKEN_D_STRING, TOKEN_D_CROSS,
	TOKEN_D_RAMP, TOKEN_D_ENTRY
	* src/theme-pixbuf.h: rename unused tokens to TOKEN_UNUSED_*

2007-01-24  Tommi Komulainen  <tommi.komulainen@nokia.com>

	Pass pixmaps directly instead of reverse engineering them from
	coordinates

	* src/sapwood-pixmap.h (sapwood_pixmap_get_pixmap)
	* src/sapwood-pixmap.c (get_pixmaps, sapwood_pixmap_get_pixmap):
	Export a function for getting pixmap and mask for each square
	* src/sapwood-pixmap.c (sapwood_pixmap_render_rects)
	* src/sapwood-pixmap.h (SapwoodRect)
	* src/sapwood-render.c (theme_pixbuf_render): replace source rectangle
	with pixmap and mask pointers

2007-01-24  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/sapwood-draw.c (draw_simple_image,draw_gap_image): remove unused
	allow_setbg parameter
	(draw_shadow,draw_arrow,draw_arrow,draw_arrow,draw_diamond,draw_box,
	draw_flat_box,draw_check,draw_option,draw_tab,draw_extension,draw_focus,
	draw_slider,draw_handle): update callers

2007-01-24  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/sapwood-draw.c (draw_simple_image, draw_gap_image): replace
	deprecated gdk_window_get_size() call with gdk_drawable_get_size()

2007-01-24  Tommi Komulainen  <tommi.komulainen@nokia.com>

	Export only symbols needed for the theme engine ABI

	* src/sapwood-pixmap.h
	* src/sapwood-proto.h
	* src/sapwood-rc-style.h
	* src/sapwood-style.h
	* src/theme-pixbuf.h: Tag internal functions with G_GNUC_INTERNAL to
	avoid symbol leakage.
	* src/Makefile.am: Add check target to verify the ABI.

2007-01-24  Jose Dapena Paz  <jdapena@igalia.com>

	* src/sapwood-server.c (extract_pixmap_single, main,
	get_display_depth): use system default visual depth for all pixmaps.
	This avoids crashing when running maemo desktop in a 24 bits color
	depth X server (bug #856).

2006-10-26  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* === Release 2.43 ===

2006-10-26  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/sapwood-render.c (theme_pixbuf_render): Limit the mask to
	clip_rect size to avoid allocating huge pixmaps.

2006-10-26  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/sapwood-render.c (theme_pixbuf_render): Trap X errors to avoid
	BadAlloc when trying to allocate *huge* bitmaps (600x33000 GtkFrame
	in a viewport) NB#35602

2006-10-26  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/Makefile.am (libsapwood_la_CFLAGS): Added to define G_LOG_DOMAIN

2006-06-13  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* === Release 2.24 ===

	* src/sapwood-server.c (pixbuf_open_response_destroy): Don't crash on
	NULL, it's a valid parameter when image loading fails.
	(process_buffer): Failure to load an image is not a client error, do
	not disconnect the client.
	N#32525

2006-05-12  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* === Release 2.19 ===

2006-05-10  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/theme-pixbuf.h (theme_pixbuf_render): Return FALSE when
	rendering fails for any reason
	* src/sapwood-draw.c (draw_simple_image): If rendering fails, do not
	apply window shape mask as it's most likely garbage
	* src/sapwood-render.c (pixmap_cache_value_new,
	theme_pixbuf_get_pixmap, theme_pixbuf_render): Do not exit, only warn
	and return error code, if pixmaps can not be loaded (someone removed
	the theme in use?)
	N#26863

2006-05-10  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* === Release 2.18 ===

2006-04-27  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/sapwood-rc-style.c (theme_parse_image): Use g_new0 rather than
	g_malloc to make sure fields are initialized.
	* src/sapwood-pixmap.c (sapwood_pixmap_get_for_file): Initialize the
	buffer to silence valgrind.
	N#27967

2006-04-27  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/sapwood-draw.c (draw_focus): Use state parameter when matching
	images for focus to allow more flexible, state-dependent focus
	theming. N#23070

2006-04-24  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* === Release 2.17 ===
	
	* src/sapwood-pixmap.c(sapwood_pixmap_free): Do not unref NULL mask.
	N#27515

2006-04-12  Tommi Komulainen  <tommi.komulainen@nokia.com>
	
	* === Release 2.14.1 ===

	* src/*.c: #include <config.h> to get configure settings correctly...
	Duh! N#26389

2006-04-03  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* === Release 2.14 ===

	* configure.in
	* NEWS: Updated

2006-04-03  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* Makefile.am (MAINTAINERCLEANFILES): Add compile and depcomp.
	* src/Makefile.am (sapwood_server_CFLAGS): Add dummy cflags to work
	with newer autotools.

2006-04-03  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/sapwood-pixmap.c (sapwood_pixmap_render_rects): Use clip mask
	only if one was drawn using the tile masks from theme.
	* src/sapwood-server.c (extract_pixmap_single): Create masks only for
	pixbufs with alpha.

2006-04-03  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/sapwood-draw.c (draw_simple_image, get_window_for_shape): Use
	flag from gtkrc to figure out need for shape mask.
	* src/sapwood-rc-style.c (theme_symbols, theme_parse_shaped,
	theme_parse_image): Add 'shaped' (default=FALSE) token to explicitly
	enable support for shaped windows from gtkrc.
	* src/theme-pixbuf.h (ThemeImage): Trade one bit from 'refcount' to
	hold the value for TOKEN_SHAPED (replaces unused TOKEN_RECOLORABLE) in
	'background_shaped' member.

2006-04-03  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/sapwood-draw.c (get_window_for_shape, draw_simple_image):
	Refactor shape mask requirement logic into separate function.

2005-09-02  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* === Release 1.36 ===

	* configure.in
	* NEWS: Updated

2005-09-02  Tommi Komulainen  <tommi.komulainen@nokia.com>
	
	* src/theme-pixbuf.h: restore TOKEN_RECOLORABLE for not to invalidate
	gtkrc cache files

2005-09-02  Tommi Komulainen  <tommi.komulainen@nokia.com>
	
	* src/theme-pixbuf.h(struct _ThemePixbuf, struct _ThemeMatchData):
	reorder and turn various members into bitfiels and save another 12k.

2005-09-02  Tommi Komulainen  <tommi.komulainen@nokia.com>
	
	* src/theme-pixbuf.h(struct _ThemePixbuf)
	* src/sapwood-render.c(theme_pixbuf_copy, theme_pixbuf_hash,
	theme_pixbuf_equal, theme_pixbuf_set_filename,
	pixmap_cache_value_new): split (absolute) filename to dirname and
	basename, keep only canonicalized copy in memory and reconstruct the
	absolute filename when needed.  Saves roughly 21k (out of 43k) memory.
	N#16158

2005-09-02  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/theme-pixbuf.h(struct _ThemeImage)
	* src/sapwood-rc-style.c(theme_symbols, theme_parse_image): remove
	unused 'recolorable' token

2005-05-27  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* === Release 1.22 ===

	* configure.in
	* NEWS: Updated

2005-05-27  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/sapwood-draw(draw_extension): Stop expanding our designated
	drawing area, it's just wrong, wrong, wrong (#9727)

2005-05-18  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/sapwood-draw(render_icon): Increase alpha of the background
	colored pixels used when dimming icons to avoid extreme contrast.

2005-05-13  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* === Release 1.20 ===

	* configure.in
	* NEWS: Updated

2005-05-13  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/sapwood-pixmap.c(sapwood_pixmap_free): Make sure all (XChangeGC)
	operations are processed before letting the sapwood server free the
	pixmaps.  Otherwise there's a risk of getting BadPixmap errors (#11906)

2005-05-03  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* === Release 1.18.1 ===

	* configure.in
	* NEWS: Updated

2005-05-02  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/sapwood-draw.c: Dim icons by drawing a simple background color
	(white) raster over the normal state icon.

	* configure.in
	* src/sapwood-server.c
	* src/Makefile.am: Remove unneeded gtk+ dependency from
	sapwood-server.

2005-04-26  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* === Release 1.18 ===

	* configure.in
	* NEWS: Updated

2005-04-26  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/sapwood-pixmap.c
	* src/sapwood-server.c
	* src/sapwood-proto.h: Change ref/unref to open/close to match
	protocol semantics.

2005-04-21  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/sapwood-render.c(theme_pixbuf_equal): Fix border equality
	check warnings, compare right to right, not right to bottom.

	* src/sapwood-render.c(theme_pixbuf_get_pixmap): theme_pixbuf_ref() has
	invalid semantics for GCache use (results in memory leak due to
	self-referencing.)  Introduce and use theme_pixbuf_copy() instead.
	* src/sapwood-render.c(theme_pixbuf_ref): Removed.

	* src/sapwood-pixmap.c: Generalize pixbuf_proto_get_pixmap() to
	pixbuf_proto_request() which can handle arbitrary requests and
	optional responses. 

	* src/sapwood-pixmap.c
	* src/sapwood-server.c
	* src/sapwood-proto.h: Rename PixbufRequest,PixbufResponse to
	PixbufRefRequest,PixbufRefResponse

	* src/sapwood-rc-style.c: Check all images for missing filenames
	instead of only 'background' and 'overlay' ('gap', 'gap_start',
	'gap_end' were missing.)

	* src/sapwood-pixmap.c
	* src/sapwood-server.c
	* src/sapwood-proto.h: Include request total length in the message to
	make trivial validation possible.

	* src/sapwood-pixmap.c
	* src/sapwood-server.c
	* src/sapwood-proto.h: Include opcode in the request message.

	* src/sapwood-server.c: Don't assume a read from the socket is a
	single whole request, be prepared for partial and multiple requests in
	the buffer.

	* src/sapwood-server.c
	* src/sapwood-proto.h: Assign a handle for each client requested image
	the client can use later to release the image.

	* src/sapwood-pixmap.c
	* src/sapwood-server.c
	* src/sapwood-proto.h: Add unref request to the protocol and release
	images from the client side.

2005-03-21  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/Makefile.am: Move sapwood server to $(libdir)/sapwood, this is
	not gtk-engines package anymore.

2005-03-21  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* configure.in: Check for abstract socket namespace
	* src/sapwood-pixmap.c
	* src/sapwood-server.c: Use abstract socket namespace if available to
	avoid leaving dangling sockets in the filesystem

2005-02-23  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* === Release 1.08 ===

	* configure.in
	* NEWS: Updated

2005-02-23  Tommi Komulainen  <tommi.komulainen@nokia.com>
	
	* src/sapwood-server.c(client_sock_callback): Remove unused variable.

2005-02-23  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* src/theme-pixbuf.h
	* src/sapwood-render.c: Switch visibility of theme_pixbuf_unref()
	and theme_pixbuf_destroy()
	* src/sapwood-rc-style.c: Always unref pixbufs rather than blindly
	destroying them.  Avoids crashing on theme change (#5533)

2004-12-21  Tommi Komulainen  <tommi.komulainen@nokia.com>

	* Creating new package by extracting (greatly modified) pixbuf engine
	from gtk-engines.

